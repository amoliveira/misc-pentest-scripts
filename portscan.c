/* 

Leonardo Militz

Software to check open ports in a host.

Use:
        
        ./portscan [IPv4] [FLAG]

        -b to scan top 10 ports (check code)
        -a to scan all ports

        Flags are obligatory.
*/

#include <stdio.h>
#include <stdlib.h>
#include <sys/socket.h>
#include <netdb.h>
#include <arpa/inet.h>
#include <string.h>

int args_validation(int argc, char *argv[]) {
	if (argc != 3) 
		return 0;

	if (argv[2] == NULL)
		return 0;

	if (strcmp(argv[2], "-a") != 0 && strcmp(argv[2], "-b") != 0)
		return 0;

	return 1;
}

int main(int argc, char *argv[]) {
	
	if (!args_validation(argc, argv)) {
		printf("\nWrong syntax\n");
		printf("\n\tUse: ./portscan [IPv4] [FLAG]");
		printf("\n\n\tUse flag -a to scan all ports.");
		printf("\n\tUse flag -b to scan common ports.\n");
		return 1;
	}

	int top_ports[] = {20,21,22,23,25,50,53,67,69,80,110,119,123,135,136,137,138,139,143,161,162,389,443,989,990,3389};
	char* ipStr = argv[1];

	struct sockaddr_in target;

	target.sin_family 		= AF_INET;
	target.sin_addr.s_addr 	= inet_addr(ipStr);

	int scan_all;
	int range[2] = {0, (sizeof(top_ports)/sizeof(int)) - 1};

	if (strcmp(argv[2], "-a") == 0) {
		scan_all = range[0] = 1;
		range[1] = 65535;
		printf("\nAll ports scan selected. Range: %d-%d\n", range[0], range[1]);
	}
	else 
		scan_all = 0;


	printf("\nScanning host: %s\n", ipStr);
	
	for (int i = range[0] ; i <= range[1] ; i++) {
		int port;
		
		if (scan_all)
			port = htons(i);
		else
			port = htons(top_ports[i]);
	
		target.sin_port = port;

		int _socket = socket(AF_INET, SOCK_STREAM, 0);
		int connection = connect(_socket, (struct sockaddr*) &target, sizeof(target));
		
		if (connection == 0) {
			printf("\n%d - [OPEN]", ntohs(port));
		}

		close(_socket);
		close(connect);
	}
 
	return 0;
}
